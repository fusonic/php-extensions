.publish-tag:
    stage: publish
    script:
        - ./bin/publish-package.sh tag
    rules:
        - if: $CI_COMMIT_TAG
          when: manual
        - when: never

.publish-branch:
    stage: publish
    script:
        - ./bin/publish-package.sh branch
    allow_failure: true
    needs: []
    rules:
        - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
          changes:
              - packages/${PACKAGE}/**/*
          when: always
        - when: manual

.phpunit-test:
    stage: test
    image: php:${PHP_VERSION}-cli-${PHP_DOCKER_RELEASE}
    interruptible: true
    variables:
        APP_ENV: prod
        XDEBUG_MODE: coverage
        XDEBUG_CONFIG: "log_level=0"
        INSTALL_PHP_EXTENSIONS: ''
    before_script:
        - |
           curl -sSLf \
             -o /usr/local/bin/install-php-extensions \
             https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions && \
             chmod +x /usr/local/bin/install-php-extensions
        - install-php-extensions @composer-2 xdebug zip
        - |
            [ -n "${INSTALL_PHP_EXTENSIONS}" ] && install-php-extensions ${INSTALL_PHP_EXTENSIONS}
        - cd packages/${PACKAGE}
        - composer validate --no-check-all
        - composer install --no-progress --no-interaction
    script:
        - vendor/bin/phpunit --coverage-cobertura=coverage/cobertura.xml --coverage-html=coverage/html --coverage-text
    environment:
        name: coverage/${PACKAGE}/${CI_COMMIT_REF_NAME}
        url: https://gitlab.com/${CI_PROJECT_PATH}/-/jobs/artifacts/${CI_COMMIT_REF_NAME}/file/packages/${PACKAGE}/coverage/html/index.html?job=${CI_JOB_NAME}
        auto_stop_in: 1 week
    artifacts:
        paths:
            - packages/${PACKAGE}/coverage
        expire_in: 1 week
        reports:
            coverage_report:
                coverage_format: cobertura
                path: packages/${PACKAGE}/coverage/cobertura.xml
    coverage: /Lines:\s*\d+\.\d+% \(\d+\/\d+\)/
    rules:
        - changes:
              - packages/${PACKAGE}/**/*
          when: always
